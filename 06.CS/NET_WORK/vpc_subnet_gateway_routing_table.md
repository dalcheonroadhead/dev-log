# 0. 들어가며

오늘은 인프라를 이해하기 위한 제일 기본적인 CS 지식을 정리하겠다. 바로 **`VPC`, `Subnet`, `gateway`, `routing_table`** 이 그것이다. 필자는 해당 개념의 존재조차 잘 알지 못했으나, 이번에 인프라 팀과 대화를 하면서 스스로 네트워크에 대한 지식이 전무함을 느끼고, 다음 회의에서는 더 잘 이해하기 위하여 학습했다. 이제 학습한 내용을 정리해보겠다.

# 1. VPC

네트워크 공간은 서부 시대 황야 처럼 드넓고 횡하다. 이 드넓은 공간에서 사람들이 교류하고 의식주를 해결하기 위해서는 같이 모여 살 **특정 공간을 지정**하고 마을을 건설해야 할 것이다. 드넓은 황야가 네트워크라면, **마을에 해당하는 부분이 바로 VPC**이다. 

![image-20250223191307122](../../../../../Documents/GitHub/dalcheonroadhead-github-blog/dalcheonroadhead.github.io/images/vpc_subnet_gateway_routing_table/image-20250223191307122.png)

![image-20250223191330497](../../../../../Documents/GitHub/dalcheonroadhead-github-blog/dalcheonroadhead.github.io/images/vpc_subnet_gateway_routing_table/image-20250223191330497.png)

VPC를 만든 나는 이제 이 새로운 도시의 시장이다. 서부 시대의 시장은 뭘 할 수 있던가? 바로 마을에 집과 농장, 창고를 지을 권한이 생긴다. 이처럼 **나만의 VPC에서는 내가 직접 네트워크를 설계할 권한을 가진다.**

## (1) 네트워크 바다 사이에서 특정 구역을 획정해 VPC로 만드는 원리

우리는 AWS나 Asure, GCP에서 VPC 생성 버튼만 누르면 그만이지만, 내부적으로 어떻게 우리가 사용할 VPC를 네트워크 바다 내에서 획정해 배정하여 주는지가 궁금해서 알아봤다.

AWS로 예를 들면 AWS는 전 세계에 데이터 센터를 가지고 있다. 이 데이터 센터에서 돌아가고 있는 수만대의 컴퓨터 본체가 바로 물리적인 서버이다. 이제 AWS의 고객이 VPC 생성을 누르면, **논리적 네트워크 분할(SDN)** 규칙에 따라 논리적으로 확정된 네트워크의 일부 구역이 고객에게 배정된다. 논리적 네트워크 분할은 이 네트워크의 바다에서 다음을 가능하게 만드는 규칙이다. 

- 1️⃣ VPC의 영역이 다른 VPC 영역 내에 생기는 것을 막는다. (모두 독립적인 공간 부여)
- 2️⃣ 사용자로부터 회수된 VPC 영역을 인식할 수 있고, 이는 다음 VPC 영역 생성에 사용한다.

## (2) VPC 생성 후 해야할 일: CIDR 블록을 활용한 내부 IP 주소 범위 설정

**`CIDR 블록`**이란, **할당받은 네트워크 내에서 사용할 IP 대역 범위를 한 번에 알 수 있는 네트워크 주소 표기법**이다. 예를 들어 **IPv4의  CIDR 블록**을 살펴보자 보통 **`10.0.0.0/16`** 과 같이 적혀있다. `/` 이전의 숫자는 하나당 1Byte 즉 8bit를 뜻한다. `/` 이후의 숫자는 **네트워크 프리픽스**라고 하는데, 이것이 바로 **IP 대역 범위를 나타낸다.** 16이라 적힌 것은 맨 오른쪽 부터 16bit는 네트워크 주소로 활용하겠다는 뜻이다. 즉 **IP 주소로는 뒤 16bit를 모두 활용할 수 있다.** 즉 IP 주소로 활용할 수 있는 범위는 0~65,535 까지 이다. 

![image-20250223193421691](../../../../../Documents/GitHub/dalcheonroadhead-github-blog/dalcheonroadhead.github.io/images/vpc_subnet_gateway_routing_table/image-20250223193421691.png)

IP 주소를 넓게 설정하면 그만큼 외부에서 들어올 수 있는 통로가 넓어지는 것을 의미해서 보안 그룹이나 ACL 세팅 시 신경써야 할 부분이 많아진다. 너무 작게 잡으면 인프라 내에서 활용할 수 있는 영역이 작아진다. 따라서 항상 적당히가 좋다. 한 번에 $2^{8}$ 이 곱해지는 것 만큼 활용 주소 범위가 넓어짐으로 주의 해야 한다.

## (3) VPC 설정의 이점

- 1️⃣ 퍼블릭 네트워크와 분리되어 보안이 강화됨
- 2️⃣ 할당된 네트워크를 Subnet으로 나누어 사용하며 네트워크 활용도가 올라감.
- 3️⃣ IP 주소 통제 (CIDR 블록 활용) 하여 네트워크 통신을 통제 가능

# 2. Subnet

**`Subnet`**은 **VPC 내부를 더 작은 네트워크 단위로 나눈 공간**을 의미한다. 

![image-20250223194031790](../../../../../Documents/GitHub/dalcheonroadhead-github-blog/dalcheonroadhead.github.io/images/vpc_subnet_gateway_routing_table/image-20250223194031790.png)

마을 안에서도 마을 사람들만 사용할 수 있는 창고, 외부인도 이용하길 바라는 상점, 마을 사람들 만의 프라이빗한 공간인 아파트로 나뉠 것이다. 이처럼 서브넷도 **퍼블릭 네트워크 공간에서도 쉽게 접근하고 활용할 수 있는 `퍼블릭 서브넷`**과 **같은 VPC 내부의 서브넷 및 자원만 활용할 수 있는 `프라이빗 서브넷`**으로 나뉜다. 프라이빗 서브넷을 더 잘게 나누면, NAT GateWay를 통해 외부에 요청을 보낼 수 있는 서브넷과, 외부 접근을 원천 차단하는 `DB용 서브넷`으로 나눌 수 있다.

## (2) 서브넷 생성 시 해야할 일

- 1️⃣ 프라이빗 서브넷인지 퍼블릭 서브넷인지 정하기
- 2️⃣ **`CIDR 블록`** 설정

두 번째를 또 해야 하는 것이 의아할 것이다. 하지만 서브넷을 만들면, **VPC에서 획정한 IP 주소 대역 중 해당 서브넷이 얼마나 사용할지를 정해야 한다.**

만약 VPC의 CIDR 주소가 `10.0.0.0/16` 이었다면, 서브넷 CIDR 주소는 <u>(1)먼저 해당 IP 주소 중 쓸 IP 대역의 큰 틀을 정하고</u> <u>(2) 그 안에서  사용할 IP 대역을 특정한다.</u> 예를 들어 `10.0.1.0/24`로 정했다면 해당 서브넷은 `10.0.0.0 ~ 10.0.0.65.535` 중 `10.0.1.0 ~ 10.0.1.255`만 사용하겠다는 뜻이다.

# 3. 게이트 웨이

**`게이트 웨이`**란 내부 네트워크(위에서 특정한 IP 대역) 과 외부 네트워크를 연결하는 **통로**이다. 

| 게이트 웨이 유형          | 역할                                                         |
| ------------------------- | ------------------------------------------------------------ |
| 인터넷 게이트 웨이        | 퍼블릭 서브넷을 인터넷과 연결                                |
| NAT 게이트웨이 (NAT GW)   | 프라이빗 서브넷에서 인터넷으로 나가는 트래픽만 허용 (들어오는 트래픽은 차단) |
| VPC 피어링 게이트웨이     | 서로 다른 VPC 간의 연결                                      |
| VPN 게이트웨이            | 클라우드와 온프레미스(사내 네트워크) 연결                    |
| Direct Connect 게이트웨이 | 클라우드와 사내 데이터센터 간의 전용 네트워크 연결           |

## (1) 게이트 웨이를 만들고 나서 주의할 점

**게이트 웨이를 만드는 행위 자체가 VPC의 연결 통로를 만드는 행위가 아니다!** 즉 GateWay를 만드는 행위는 마을로 향하는 다리 자체를 만드는 것이지, **해당 다리를 마을에 설치하는 행위가 아니다.** 따라서 마을에 다리를 설치하는 것은 따로 해야하는데 이것에 필요한 것이 바로 **라우팅 테이블** 이다. 라우팅 테이블은 **서브넷 별로 어떤 GateWay를 사용할 것인지 적힌 명세** 이다.

| 대상 네트워크 | 대상   | 설명                                       | 연결 서브넷             |
| ------------- | ------ | ------------------------------------------ | ----------------------- |
| 10.0.0.0/16   | local  | VPC 내부 통신                              | 10.0.0.0 ~ 10.0.255.254 |
| 0.0.0.0/0     | NAT GW | 프라이빗 서브넷에서 인터넷으로 나가는 경로 | 10.0.2.0/24             |

이렇게 하면 첫 번째는 모든 서브넷이 사용하는 게이트웨이이고, 두 번째는 프라이빗 서브넷인 10.0.2.0/24가 사용하는 서브넷이다.

## (2) NAT GATEWAY란?

**`NAT(Network Address Translation) 게이트웨이`**는 프라이빗 서브넷에 있는 서버가 인터넷에 접근할 수 있도록 도와주는 게이트웨이 이다. 반대로 외부(인터넷)에서 프라이빗 서브넷의 서버로 직접 접근하는 것은 차단된다. 

### 작동 원리

1️⃣ **프라이빗 서브넷 서버(10.0.2.10)가 인터넷 요청을 보냄 (예: 구글 접속 `8.8.8.8`)**
2️⃣ **NAT Gateway가 내부 IP(`10.0.2.10`)를 공인 IP(`3.3.3.3` 등)로 변환하여 인터넷에 전달**
3️⃣ **구글(`8.8.8.8`)이 응답을 보내면, NAT Gateway가 다시 공인 IP를 내부 IP(`10.0.2.10`)로 변환하여 전달**
4️⃣ **서버는 정상적으로 인터넷을 사용**



| 비교 항목     | NAT Gateway (클라우드)        | 라우터의 NAT (일반 네트워크) |
| ------------- | ----------------------------- | ---------------------------- |
| 사용 환경     | 클라우드 (AWS, GCP, Azure)    | 가정, 사무실, 데이터센터     |
| NAT 수행 방식 | 클라우드에서 완전 관리        | 직접 NAT 설정 필요           |
| 성능          | 클라우드에서 자동 확장        | 하드웨어 성능에 따라 제한    |
| 보안          | 외부에서 접근 불가능 (일방향) | 포트 포워딩 등으로 접근 가능 |
| 관리 방식     | AWS/GCP에서 설정만 하면 됨    | 수동으로 라우터 설정 필요    |
|               |                               |                              |

